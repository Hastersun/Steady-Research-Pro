---
// ResearchAgentUI: Deep Research Agent ç•Œé¢éª¨æ¶ï¼ˆé™æ€ç‰ˆï¼Œåç»­å¯æ¥å…¥é€»è¾‘ï¼‰
import SidePanel from './agent/SidePanel.astro'
import ResultsGrid from './agent/ResultsGrid.astro'
---
<section class="min-h-screen flex flex-col lg:flex-row gap-6">
  <SidePanel />
  <div class="flex-1 space-y-6">
    <div class="relative overflow-hidden rounded-2xl glass-card border border-white/10 px-6 py-8 md:px-8 md:py-9 text-slate-100">
      <span class="card-accent-gradient"></span>
      <div class="relative z-10 flex flex-col gap-6 lg:flex-row lg:items-center">
        <div class="flex-1 space-y-4">
          <span class="badge-soft" data-i18n="hero.realtimeBadge">Realtime orchestration</span>
          <div class="space-y-2">
            <h1 class="text-3xl font-semibold tracking-tight" data-i18n="hero.title">Deep Research Agent</h1>
            <p class="text-sm text-slate-200/80 max-w-xl" data-i18n="hero.description">æ™ºèƒ½èšåˆå¤šæºä¿¡æ¯ï¼Œé©±åŠ¨å¯è§†åŒ–æ¨ç†ä¸æœç´¢æ—¥å¿—ã€‚é€šè¿‡äº‹ä»¶æ€»çº¿ä¸æµå¼åç«¯åä½œï¼Œå®ç°ç”±æµ…åˆ°æ·±çš„æ´å¯Ÿç”Ÿæˆã€‚</p>
          </div>
          <div class="flex flex-wrap gap-2 text-[11px] text-slate-200/80">
            <span class="inline-flex items-center gap-1.5 rounded-full border border-white/10 bg-white/5 px-3 py-1" data-i18n="hero.capabilitySse">âš¡ SSE æ¨ç†</span>
            <span class="inline-flex items-center gap-1.5 rounded-full border border-white/10 bg-white/5 px-3 py-1" data-i18n="hero.capabilitySearch">ğŸ” å¤šæºæœç´¢</span>
            <span class="inline-flex items-center gap-1.5 rounded-full border border-white/10 bg-white/5 px-3 py-1" data-i18n="hero.capabilityTimeline">ğŸ§­ æ—¶é—´çº¿è¿½è¸ª</span>
            <span class="inline-flex items-center gap-1.5 rounded-full border border-white/10 bg-white/5 px-3 py-1" data-i18n="hero.capabilityReport">ğŸ—‚ï¸ èšåˆæŠ¥å‘Š</span>
          </div>
        </div>
        <dl class="grid grid-cols-2 gap-4 lg:w-72">
          <div class="rounded-xl border border-white/10 bg-white/5 p-4">
            <dt class="text-[10px] uppercase tracking-[0.28em] text-slate-400" data-i18n="hero.currentTask">å½“å‰ä»»åŠ¡</dt>
            <dd id="current-task-value" class="mt-2 text-2xl font-semibold text-white" data-i18n="hero.currentTaskIdle">Idle</dd>
            <dd class="mt-1 text-[11px] text-slate-300/80" data-i18n="hero.currentTaskHint">ç­‰å¾…ç ”ç©¶ä¸»é¢˜</dd>
          </div>
          <div class="rounded-xl border border-white/10 bg-white/5 p-4">
            <dt class="text-[10px] uppercase tracking-[0.28em] text-slate-400" data-i18n="hero.latestOutput">æœ€æ–°è¾“å‡º</dt>
            <dd id="latest-output-value" class="mt-2 text-2xl font-semibold text-white">â€”</dd>
            <dd class="mt-1 text-[11px] text-slate-300/80" data-i18n="hero.latestOutputHint">æœ€è¿‘ä¸€æ¬¡å®Œæˆæ—¶é—´</dd>
          </div>
        </dl>
      </div>
    </div>
    <div class="grid gap-4 md:grid-cols-3">
      <div class="glass-card glass-card--muted rounded-2xl border border-white/10 px-4 py-5 text-xs text-slate-200/85">
        <p class="text-sm font-semibold text-white/90" data-i18n="hero.quickStartTitle">ğŸ¯ å¿«é€Ÿå¼€å§‹</p>
        <p class="mt-2 leading-relaxed" data-i18n="hero.quickStartDescription">åœ¨å·¦ä¾§å¡«å†™ä¸»é¢˜å¹¶é€‰æ‹©æ¨¡å‹ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è§„æ•´ç ”ç©¶æµç¨‹å¹¶åŒæ­¥æ¨ç†è½¨è¿¹ã€‚</p>
      </div>
      <div class="glass-card glass-card--muted rounded-2xl border border-white/10 px-4 py-5 text-xs text-slate-200/85">
        <p class="text-sm font-semibold text-white/90" data-i18n="hero.staySyncedTitle">ğŸ” ä¿æŒåŒæ­¥</p>
        <p class="mt-2 leading-relaxed" data-i18n="hero.staySyncedDescription">Settings ä¸­åˆ‡æ¢æœåŠ¡åï¼ŒSidePanel ä¼šè‡ªåŠ¨åˆ·æ–°å¯ç”¨æ¨¡å‹åˆ—è¡¨å¹¶æç¤ºè”æœºçŠ¶æ€ã€‚</p>
      </div>
      <div class="glass-card glass-card--muted rounded-2xl border border-white/10 px-4 py-5 text-xs text-slate-200/85">
        <p class="text-sm font-semibold text-white/90" data-i18n="hero.exportTitle">ğŸ“¦ å¯¼å‡ºç»“æœ</p>
        <p class="mt-2 leading-relaxed" data-i18n="hero.exportDescription">å®Œæˆåå¯åœ¨ç»“æœå¡ç‰‡ä¸­æ‰©å±•è¯¦æƒ…ï¼Œæ•´ç†ç»“æ„åŒ–ç»“è®ºä¸å¼•ç”¨æ¥æºã€‚</p>
      </div>
    </div>
    <div id="reasoning-panel" class="rounded-2xl border border-brand-300/35 bg-slate-900/55 px-5 py-4 space-y-3 text-xs text-slate-200/80 backdrop-blur hidden animate-fade-in">
      <h2 class="text-xs font-semibold tracking-wide text-brand-200 flex items-center gap-1 uppercase" data-i18n="hero.reasoningTitle">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l4 2"/></svg>
        æ¨ç†è½¨è¿¹
      </h2>
      <ol id="reasoning-steps" class="space-y-2"></ol>
    </div>
    <div id="search-log" class="rounded-2xl border border-white/10 bg-slate-900/55 px-5 py-4 hidden text-[11px] leading-relaxed space-y-1 font-mono text-slate-200/70 overflow-auto max-h-56 backdrop-blur"></div>
    <ResultsGrid />
  </div>
</section>
<script>
  // @ts-nocheck
  const stepsEl = document.getElementById('reasoning-steps');
  const reasoningPanel = document.getElementById('reasoning-panel');
  const searchLog = document.getElementById('search-log');
  const heroTaskValue = document.getElementById('current-task-value');
  const latestOutputValue = document.getElementById('latest-output-value');
  const resultsGrid = document.getElementById('results-grid');
  const resultsEmpty = document.getElementById('results-empty');
  const sourcesBody = document.getElementById('sources-table-body');
  const sourcesEmptyRow = document.getElementById('sources-empty-row');
  const sourcesEmptyCell = sourcesEmptyRow ? sourcesEmptyRow.querySelector('td') : null;
  const sourcesHint = document.getElementById('sources-update-hint');
  const sourcesEmptyDefault = sourcesEmptyCell ? sourcesEmptyCell.textContent : '';
  const sourcesHintDefault = sourcesHint ? sourcesHint.textContent : '';

  const steadyI18n = (window).__steadyI18n || {};
  const translate = (key, params, fallback) => {
    try {
      if (steadyI18n && typeof steadyI18n.t === 'function') {
        return steadyI18n.t(key, params);
      }
    } catch (error) {
      console.warn('[i18n] translation error', error);
    }
    return typeof fallback === 'string' ? fallback : key;
  };

  const LEGACY_PIPELINE = [
    { id: 'plan', stepType: 'plan', key: 'researchFlow.pipelinePlan', fallback: 'ç”Ÿæˆåˆæ­¥ç ”ç©¶è®¡åˆ’' },
    { id: 'search', stepType: 'search', key: 'researchFlow.pipelineSearch', fallback: 'å¤šæºæœç´¢ä¸æŠ“å–' },
    { id: 'extract', stepType: 'extract', key: 'researchFlow.pipelineExtract', fallback: 'å†…å®¹æ¸…æ´—ä¸æ‘˜è¦æŠ½å–' },
    { id: 'cluster', stepType: 'cluster', key: 'researchFlow.pipelineCluster', fallback: 'ä¸»é¢˜èšç±»ä¸å½’çº³' },
    { id: 'synthesis', stepType: 'synthesis', key: 'researchFlow.pipelineSynthesis', fallback: 'ç»¼åˆåˆ†æä¸æ´å¯Ÿè¾“å‡º' }
  ];

  const DEEP_PIPELINE = [
    { id: 'plan', stepType: 'plan', key: 'researchFlow.pipelinePlan', fallback: 'ç”Ÿæˆåˆæ­¥ç ”ç©¶è®¡åˆ’' },
    { id: 'deep_search', stepType: 'deep_search', key: 'researchFlow.pipelineDeepSearch', fallback: 'å¤šæºæ·±åº¦æœç´¢' },
    { id: 'modeling', stepType: 'modeling', key: 'researchFlow.pipelineModeling', fallback: 'ç»“æ„åŒ–å»ºæ¨¡' },
    { id: 'reporting', stepType: 'reporting', key: 'researchFlow.pipelineReporting', fallback: 'æ™ºèƒ½æŠ¥å‘Šç”Ÿæˆ' }
  ];

  let pipeline = LEGACY_PIPELINE;
  const stepNodes = new Map();
  const stepStatus = new Map();
  const state = {
    mode: 'legacy',
    query: '',
    results: {},
    reportDraft: ''
  };

  const translationKeys = {
    heroIdle: 'hero.currentTaskIdle',
    heroWorking: 'hero.currentTaskWorking',
    heroComplete: 'hero.currentTaskComplete'
  };

  function setPipeline(mode) {
    pipeline = mode === 'deep' ? DEEP_PIPELINE : LEGACY_PIPELINE;
  }

  function getStepDefinition(stepType) {
    return pipeline.find((step) => step.stepType === stepType) || null;
  }

  function escapeHtml(value) {
    if (typeof value !== 'string') return '';
    return value
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function formatTimestamp(input) {
    if (!input) return '';
    const date = typeof input === 'string' ? new Date(input) : input;
    if (Number.isNaN(date?.getTime?.())) return '';
    return date.toLocaleString();
  }

  function resolveMessage(update) {
    if (!update) return '';
    if (update.messageKey) {
      try {
        return translate(update.messageKey, update.messageParams || {}, update.message || update.messageKey);
      } catch (error) {
        console.warn('[research-ui] translate message failed', error);
      }
    }
    return update.message || '';
  }

  function resetUI(query) {
    stepNodes.clear();
    stepStatus.clear();
    if (stepsEl) stepsEl.innerHTML = '';
    if (reasoningPanel) reasoningPanel.classList.add('hidden');
    if (searchLog) {
      searchLog.innerHTML = '';
      searchLog.classList.add('hidden');
    }
    if (resultsGrid) {
      const dynamicCards = resultsGrid.querySelectorAll('[data-dynamic-card="true"]');
      dynamicCards.forEach((node) => node.remove());
    }
    if (resultsEmpty) {
      resultsEmpty.classList.remove('hidden');
    }
    if (sourcesBody) {
      const dynamicRows = sourcesBody.querySelectorAll('[data-dynamic-row="true"]');
      dynamicRows.forEach((row) => row.remove());
    }
    if (sourcesEmptyRow) {
      sourcesEmptyRow.classList.remove('hidden');
    }
    if (sourcesHint) {
      sourcesHint.classList.add('hidden');
      if (sourcesHintDefault) {
        sourcesHint.textContent = sourcesHintDefault;
      }
    }
    if (sourcesEmptyCell && sourcesEmptyDefault) {
      sourcesEmptyCell.textContent = sourcesEmptyDefault;
    }
    state.results = {};
    state.reportDraft = '';
    state.query = query || '';
  }

  function ensureReasoningPanelVisible() {
    if (reasoningPanel) {
      reasoningPanel.classList.remove('hidden');
    }
  }

  function createReasoningStep(label, stepType) {
    if (!stepsEl) return null;
    const index = stepsEl.children.length + 1;
    const li = document.createElement('li');
    li.className = 'rounded-xl border border-brand-300/30 bg-slate-900/55 shadow-soft backdrop-blur animate-slide-up';
    li.style.animationDelay = `${index * 40}ms`;
    li.dataset.stepType = stepType;
    const summaryId = `rs-summary-${stepType}-${index}`;
    const pendingText = translate('researchFlow.detailPending', {}, 'å¾…æ‰§è¡Œ');
    li.innerHTML = `
      <button type="button" id="${summaryId}" class="group w-full flex items-center justify-between gap-3 px-4 py-3 text-left cursor-pointer select-none text-slate-200/85">
        <span class="flex items-center gap-2 text-[11px] font-medium tracking-wide text-brand-200 uppercase">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M12 5l7 7-7 7"/></svg>
          Step ${String(index).padStart(2, '0')}
        </span>
        <span class="flex-1 truncate text-[11px] text-slate-400">${label}</span>
        <span class="status text-[10px] font-medium text-slate-500">${pendingText}</span>
        <svg class="chevron w-3.5 h-3.5 text-slate-500 transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
      </button>
      <div class="detail px-5 pt-0 pb-3 space-y-1 text-[11px] leading-relaxed text-slate-300/85 border-t border-brand-300/20 overflow-hidden max-h-0 opacity-0 transition-all duration-300 ease-out"></div>
    `;
    stepsEl.appendChild(li);

    const summaryBtn = li.querySelector(`#${summaryId}`);
    const detailEl = li.querySelector('.detail');
    const statusEl = li.querySelector('.status');
    const chevron = li.querySelector('.chevron');

    function toggleDetail(detail, chev) {
      const expanded = detail.getAttribute('data-open') === 'true';
      if (expanded) {
        detail.setAttribute('data-open', 'false');
        if (detail instanceof HTMLElement) {
          detail.style.maxHeight = '0px';
          detail.style.opacity = '0';
        }
        chev?.classList.remove('rotate-180');
      } else {
        detail.setAttribute('data-open', 'true');
        if (detail instanceof HTMLElement) {
          detail.style.maxHeight = detail.scrollHeight + 'px';
          detail.style.opacity = '1';
        }
        chev?.classList.add('rotate-180');
      }
    }

    summaryBtn?.addEventListener('click', () => {
      if (!detailEl || !chevron) return;
      toggleDetail(detailEl, chevron);
    });

    function addLine(text, type = 'log') {
      if (!detailEl) return;
      const line = document.createElement('div');
      line.className = 'relative pl-3';
      let indicator = 'bg-brand-400/70';
      if (type === 'done') {
        indicator = 'bg-emerald-300';
        line.classList.add('text-brand-200', 'font-medium');
      } else if (type === 'error') {
        indicator = 'bg-rose-400';
        line.classList.add('text-rose-300');
      }
      line.innerHTML = `<span class="absolute left-0 top-1 w-1 h-1 rounded-full ${indicator}"></span>${escapeHtml(text)}`;
      detailEl.appendChild(line);
      if (detailEl.getAttribute('data-open') === 'true' && detailEl instanceof HTMLElement) {
        detailEl.style.maxHeight = detailEl.scrollHeight + 'px';
      }
    }

    function setStatus(text, toneClass) {
      if (!statusEl) return;
      statusEl.textContent = text;
      statusEl.className = `status text-[10px] font-medium ${toneClass}`;
    }

    function start() {
      setStatus(translate('researchFlow.detailRunning', {}, 'æ‰§è¡Œä¸­'), 'text-brand-400');
      addLine(translate('researchFlow.detailStart', { label }, `å¼€å§‹: ${label}`));
    }

    function finish() {
      setStatus(translate('researchFlow.detailDone', {}, 'å®Œæˆ'), 'text-emerald-400');
      addLine(translate('researchFlow.detailFinish', {}, 'å®Œæˆ âœ“'), 'done');
    }

    function setError(message) {
      setStatus(translate('researchFlow.detailError', {}, 'å¼‚å¸¸'), 'text-rose-400');
      addLine(message || translate('researchFlow.detailError', {}, 'å‘ç”Ÿé”™è¯¯'), 'error');
    }

    function expand() {
      if (!detailEl || !(detailEl instanceof HTMLElement)) return;
      detailEl.setAttribute('data-open', 'true');
      detailEl.style.maxHeight = detailEl.scrollHeight + 'px';
      detailEl.style.opacity = '1';
      chevron?.classList.add('rotate-180');
    }

    return { start, finish, addLine, setError, expand };
  }

  function ensureReasoningStep(stepType) {
    if (stepNodes.has(stepType)) {
      return stepNodes.get(stepType);
    }
    const stepDef = getStepDefinition(stepType);
    const label = translate(stepDef?.key || '', {}, stepDef?.fallback || stepType);
    const step = createReasoningStep(label, stepType);
    if (step) {
      stepNodes.set(stepType, step);
    }
    return step;
  }

  function appendSearchLog(text) {
    if (!searchLog || !text) return;
    searchLog.classList.remove('hidden');
    const line = document.createElement('div');
    const count = searchLog.children.length;
    line.className = 'animate-fade-in';
    line.style.animationDelay = `${count * 40}ms`;
    line.textContent = text;
    searchLog.appendChild(line);
    searchLog.scrollTop = searchLog.scrollHeight;
  }

  function createCard({ id, order, title, badge, bodyHtml, footerHtml }) {
    const article = document.createElement('article');
    article.className = 'group relative overflow-hidden rounded-2xl border border-white/10 bg-slate-900/55 backdrop-blur p-6 shadow-soft transition-all duration-300 hover:-translate-y-1 hover:border-brand-400/40 hover:shadow-xl animate-slide-up';
    article.dataset.dynamicCard = 'true';
    article.dataset.cardId = id;
    article.style.animationDelay = `${order * 70}ms`;
    article.innerHTML = `
      <div class="absolute inset-0 opacity-0 transition-opacity duration-300 group-hover:opacity-100" style="background: radial-gradient(circle at top, rgba(45, 212, 191, 0.22), transparent 60%);"></div>
      <div class="relative flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="inline-flex h-7 w-7 items-center justify-center rounded-full border border-white/10 bg-white/10 text-[11px] font-semibold text-white/80">${String(order + 1).padStart(2, '0')}</span>
          <h3 class="text-sm font-semibold text-white flex items-center gap-2">
            <svg class="w-4 h-4 text-brand-200" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l4 2"/></svg>
            <span>${title}</span>
          </h3>
        </div>
        <span class="text-[11px] uppercase tracking-[0.22em] text-slate-400/70">${badge}</span>
      </div>
      <div class="relative mt-3 text-xs text-slate-200/80 space-y-2 leading-relaxed">${bodyHtml}</div>
      ${footerHtml ? `<div class="relative mt-4 text-[11px] text-slate-300/70">${footerHtml}</div>` : ''}
    `;
    return article;
  }

  function renderResults() {
    if (!resultsGrid) return;
    const dynamicCards = resultsGrid.querySelectorAll('[data-dynamic-card="true"]');
    dynamicCards.forEach((node) => node.remove());

    const cards = [];
    const plan = state.results.plan;
    const searchResult = state.results.deep_search || state.results.search;
    const modeling = state.results.modeling;
    const reporting = state.results.reporting;

    if (plan?.content) {
      const paragraphs = plan.content.split(/\n+/).filter(Boolean).map((line) => `<p>${escapeHtml(line)}</p>`).join('');
      cards.push({
        id: 'plan-card',
        title: translate('resultsGrid.planTitle', {}, 'ç ”ç©¶è®¡åˆ’'),
        badge: 'PLAN',
        bodyHtml: `<div class="space-y-2">${paragraphs}</div>`,
        footerHtml: plan.timestamp ? translate('resultsGrid.generatedAt', { time: formatTimestamp(plan.timestamp) }, `ç”Ÿæˆæ—¶é—´ï¼š${formatTimestamp(plan.timestamp)}`) : ''
      });
    }

    if (searchResult) {
      const highlights = Array.isArray(searchResult.summary?.highlights) ? searchResult.summary.highlights.slice(0, 4) : [];
      const notes = Array.isArray(searchResult.notes) ? searchResult.notes.slice(0, 3) : [];
      const metadata = searchResult.metadata || {};
      const fallbackPrimaryMessage = metadata.fallbackMessage || translate('resultsGrid.fallbackDefault', {}, 'æœç´¢ä½¿ç”¨äº†å›é€€ç­–ç•¥ã€‚');
      let fallbackSecondaryMessage = '';
      if (metadata.fallbackReason === 'summarize_unavailable') {
        fallbackSecondaryMessage = translate('resultsGrid.fallbackSummarize', {}, 'æ‘˜è¦ç”Ÿæˆæš‚ä¸å¯ç”¨ï¼Œå±•ç¤ºåŸå§‹æœç´¢ç»“æœã€‚');
      } else if (metadata.fallbackReason === 'api_error') {
        fallbackSecondaryMessage = translate('resultsGrid.fallbackApi', {}, 'æœç´¢æ¥å£å¼‚å¸¸ï¼Œå·²å±•ç¤ºå¯ç”¨çš„ç¼“å­˜æˆ–è®¡åˆ’ã€‚');
      } else if (metadata.fallbackReason === 'no_results') {
        fallbackSecondaryMessage = translate('resultsGrid.fallbackEmpty', {}, 'æœªæ£€ç´¢åˆ°å¯é æ¥æºï¼Œå±•ç¤ºåŸºç¡€ç­–ç•¥ä¾›å‚è€ƒã€‚');
      }
      const fallbackNotice = metadata.isFallback
        ? `
            <div class="flex items-start gap-2 rounded-lg border border-amber-200/40 bg-amber-500/10 px-3 py-2 text-[11px] text-amber-50">
              <span class="mt-0.5">âš ï¸</span>
              <div class="space-y-1">
                <p class="font-medium text-amber-100">${escapeHtml(fallbackPrimaryMessage)}</p>
                ${fallbackSecondaryMessage ? `<p class="text-amber-200/90">${escapeHtml(fallbackSecondaryMessage)}</p>` : ''}
              </div>
            </div>
          `
        : '';
      const highlightHtml = highlights.length
        ? `<ul class="list-disc ps-5 space-y-1">${highlights.map((item) => `<li>${escapeHtml(item)}</li>`).join('')}</ul>`
        : '';
      const noteHtml = notes.length
        ? notes.map((note) => `
            <div class="rounded-lg border border-white/10 bg-white/5 px-3 py-2">
              <p class="font-medium text-slate-100/90">${escapeHtml(note.topic || note.summary || '')}</p>
              <p class="text-[11px] text-slate-300/80 mt-1 line-clamp-3">${escapeHtml(note.summary || '')}</p>
            </div>
          `).join('')
        : '';
      const metaParts = [];
      if (Array.isArray(searchResult.strategy?.queries)) {
        metaParts.push(`æŸ¥è¯¢ ${searchResult.strategy.queries.length} ä¸ª`);
      }
      if (typeof searchResult.metadata?.resultsCount === 'number') {
        metaParts.push(`ç»“æœ ${searchResult.metadata.resultsCount} æ¡`);
      }
      if (metadata.isFallback) {
        metaParts.push(translate('resultsGrid.footerFallback', {}, 'å›é€€æ¨¡å¼'));
      }
      let combinedBody = '';
      if (fallbackNotice) combinedBody += fallbackNotice;
      if (highlightHtml) combinedBody += highlightHtml;
      if (noteHtml) combinedBody += noteHtml;
      if (!combinedBody) {
        combinedBody = `<p class="text-[11px] text-slate-300/70">${escapeHtml(translate('resultsGrid.searchAwaiting', {}, 'ç­‰å¾…æœç´¢æ‘˜è¦'))}</p>`;
      }
      cards.push({
        id: 'search-card',
        title: translate('resultsGrid.sectionBenchmark', {}, 'æœç´¢æ´å¯Ÿ'),
        badge: 'SEARCH',
        bodyHtml: `<div class="space-y-2">${combinedBody}</div>`,
        footerHtml: metaParts.join(' Â· ')
      });
    }

    if (modeling) {
      const drivers = Array.isArray(modeling.coreDrivers) ? modeling.coreDrivers.slice(0, 4) : [];
      const driverHtml = drivers.length
        ? drivers.map((driver, index) => `
            <div class="flex items-start gap-2">
              <span class="mt-0.5 text-[11px] text-brand-200">${String(index + 1).padStart(2, '0')}</span>
              <div>
                <p class="text-xs font-medium text-slate-100/90">${escapeHtml(driver.name || 'å…³é”®é©±åŠ¨')}</p>
                <p class="text-[11px] text-slate-300/80 mt-0.5 line-clamp-3">${escapeHtml(driver.description || '')}</p>
              </div>
            </div>
          `).join('')
        : '<p class="text-[11px] text-slate-300/70">ç­‰å¾…å»ºæ¨¡ç»“æœ</p>';
      cards.push({
        id: 'model-card',
        title: translate('resultsGrid.sectionFramework', {}, 'ç»“æ„åŒ–æ¨¡å‹'),
        badge: 'MODEL',
        bodyHtml: `<div class="space-y-2">${driverHtml}</div>`,
        footerHtml: modeling.metadata?.method ? `Method Â· ${escapeHtml(modeling.metadata.method)}` : ''
      });
    }

    const reportContent = reporting?.markdown || state.reportDraft;
    if (reportContent) {
      const preview = reportContent.split('\n').slice(0, 8).map((line) => escapeHtml(line)).join('<br />');
      cards.push({
        id: 'report-card',
        title: translate('resultsGrid.sectionAction', {}, 'æ´å¯ŸæŠ¥å‘Š'),
        badge: 'REPORT',
        bodyHtml: `<p class="font-mono text-[11px] leading-relaxed whitespace-pre-wrap">${preview}</p>`,
        footerHtml: reporting?.metadata?.format ? `Format Â· ${escapeHtml(reporting.metadata.format)}` : ''
      });
    }

    if (!cards.length) {
      if (resultsEmpty) resultsEmpty.classList.remove('hidden');
      return;
    }

    if (resultsEmpty) resultsEmpty.classList.add('hidden');

    cards.forEach((card, index) => {
      const node = createCard({ ...card, order: index });
      resultsGrid.appendChild(node);
    });
  }

  function getDomain(url) {
    try {
      const { hostname } = new URL(url);
      return hostname.replace(/^www\./, '');
    } catch (error) {
      return '';
    }
  }

  function renderSources() {
    if (!sourcesBody) return;
    const dynamicRows = sourcesBody.querySelectorAll('[data-dynamic-row="true"]');
    dynamicRows.forEach((row) => row.remove());

    const searchResult = state.results.deep_search || state.results.search;
    const metadata = searchResult?.metadata || {};
    const notes = Array.isArray(searchResult?.notes) ? searchResult.notes : [];
    const rawResults = Array.isArray(searchResult?.rawResults) ? searchResult.rawResults : [];

    const entries = notes.length ? notes : rawResults;

    if (sourcesHint) {
      if (metadata.isFallback && metadata.fallbackReason === 'summarize_unavailable') {
        sourcesHint.textContent = translate('sourcesTable.hintSummarizeFallback', {}, 'æ‘˜è¦å¤±è´¥ï¼Œå·²å±•ç¤ºåŸå§‹æ¥æºåˆ—è¡¨ã€‚');
      } else if (metadata.isFallback && metadata.fallbackMessage) {
        sourcesHint.textContent = metadata.fallbackMessage;
      } else if (sourcesHintDefault) {
        sourcesHint.textContent = sourcesHintDefault;
      }
    }

    if (!entries.length) {
      if (sourcesEmptyCell) {
        if (metadata.isFallback && metadata.fallbackReason === 'no_results') {
          sourcesEmptyCell.textContent = translate('sourcesTable.emptyNoResults', {}, 'æœç´¢æ²¡æœ‰è¿”å›æ¥æºï¼Œä¿ç•™ç­–ç•¥å»ºè®®ä¾›å‚è€ƒã€‚');
        } else if (metadata.isFallback && metadata.fallbackReason === 'api_error') {
          sourcesEmptyCell.textContent = translate('sourcesTable.emptyApiFallback', {}, 'æœç´¢æ¥å£å¼‚å¸¸ï¼Œæš‚æ— æ³•å±•ç¤ºæ¥æºåˆ—è¡¨ã€‚');
        } else if (sourcesEmptyDefault) {
          sourcesEmptyCell.textContent = sourcesEmptyDefault;
        }
      }
      sourcesEmptyRow?.classList.remove('hidden');
      sourcesHint?.classList.add('hidden');
      return;
    }

    if (sourcesEmptyCell && sourcesEmptyDefault) {
      sourcesEmptyCell.textContent = sourcesEmptyDefault;
    }
    sourcesEmptyRow?.classList.add('hidden');
    sourcesHint?.classList.remove('hidden');

    entries.slice(0, 10).forEach((item) => {
      const title = item.title || item.summary || item.topic || 'â€”';
      const url = item.sourceUrl || item.url || item.link || '';
      const domain = url ? getDomain(url) : (item.domain || 'â€”');
      const type = item.engine || item.type || 'Source';
      const score = typeof item.confidence === 'number' ? item.confidence.toFixed(2) : (typeof item.score === 'number' ? item.score.toFixed(2) : 'â€”');

      const tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-50/70 animate-fade-in';
      tr.dataset.dynamicRow = 'true';
      tr.innerHTML = `
        <td class="py-2 pe-4 max-w-[220px]"><div class="line-clamp-2 font-medium text-gray-700">${escapeHtml(title)}</div></td>
        <td class="py-2 pe-4 text-gray-500">${escapeHtml(domain)}</td>
        <td class="py-2 pe-4"><span class="inline-flex items-center rounded bg-brand-50 px-2 py-0.5 text-[10px] font-medium text-brand-700 ring-1 ring-inset ring-brand-200/70">${escapeHtml(type)}</span></td>
        <td class="py-2 pe-4 font-medium text-gray-800">${score}</td>
        <td class="py-2">
          ${url ? `<a class="inline-flex items-center gap-1 rounded-full border border-gray-200 px-2 py-1 text-[11px] text-gray-500 hover:border-brand-300 hover:text-brand-500" href="${escapeHtml(url)}" target="_blank" rel="noopener">æŸ¥çœ‹</a>` : '<span class="text-[11px] text-gray-400">N/A</span>'}
        </td>
      `;
      sourcesBody.appendChild(tr);
    });
  }

  function updateHeroStatus(text) {
    if (heroTaskValue) {
      heroTaskValue.textContent = text || translate(translationKeys.heroIdle, {}, 'Idle');
    }
  }

  function handleResearchStart(event) {
    const detail = event?.detail || {};
    const mode = detail.mode === 'deep' ? 'deep' : 'legacy';
    const query = detail.query || '';
    state.mode = mode;
    setPipeline(mode);
    resetUI(query);
    updateHeroStatus(query || translate(translationKeys.heroIdle, {}, 'Idle'));
    if (latestOutputValue) latestOutputValue.textContent = 'â€”';
    renderResults();
    renderSources();
  }

  function handleResearchUpdate(event) {
    const detail = event?.detail || {};
    const payload = typeof detail.data === 'string' ? { raw: detail.data } : (detail.data || {});
    const stepType = payload.stepType || detail.stepType || detail.stepId;
    if (!stepType) return;

    const stepDef = getStepDefinition(stepType) || { stepType, key: '', fallback: stepType };
    const label = translate(stepDef.key || '', {}, stepDef.fallback || stepType);
    const step = ensureReasoningStep(stepType);
    const message = resolveMessage(detail) || resolveMessage(payload);
    const status = detail.status;

    ensureReasoningPanelVisible();

    if (status === 'start') {
      step?.start?.();
      stepStatus.set(stepType, 'active');
      updateHeroStatus(label);
    } else if (status === 'progress') {
      if (message) step?.addLine?.(message);
      stepStatus.set(stepType, 'active');
      updateHeroStatus(message || label);
    } else if (status === 'complete') {
      step?.finish?.();
      stepStatus.set(stepType, 'done');
      if (payload.result) {
        state.results[stepType] = payload.result;
        if (stepType === 'deep_search') {
          state.results.search = payload.result;
        }
        if (stepType === 'search' && !state.results.deep_search) {
          state.results.deep_search = payload.result;
        }
        if (stepType === 'cluster' && !state.results.modeling) {
          state.results.modeling = payload.result;
        }
        if (stepType === 'reporting') {
          state.results.reporting = payload.result;
          state.reportDraft = payload.result.markdown || state.reportDraft;
        }
        if (stepType === 'synthesis') {
          state.results.reporting = payload.result;
          if (typeof payload.result?.content === 'string') {
            state.reportDraft = payload.result.content;
          }
        }
        if (stepType === 'plan') {
          state.results.plan = payload.result;
        }
        renderResults();
        renderSources();
      }
      updateHeroStatus(label);
      const finalStep = pipeline[pipeline.length - 1];
      if (finalStep && (finalStep.stepType === stepType || finalStep.id === stepType)) {
        updateHeroStatus(translate(translationKeys.heroComplete, {}, 'ç ”ç©¶å®Œæˆ'));
        if (latestOutputValue) {
          latestOutputValue.textContent = formatTimestamp(detail.timestamp || new Date());
        }
      }
    } else if (status === 'error') {
      const errorMessage = message || translate('researchFlow.detailError', {}, 'å‘ç”Ÿé”™è¯¯');
      step?.setError?.(errorMessage);
      stepStatus.set(stepType, 'error');
      appendSearchLog(`âš ï¸ ${errorMessage}`);
      updateHeroStatus(errorMessage);
    }

    if (stepType === 'deep_search') {
      if (status === 'progress' && message) {
        appendSearchLog(message);
      } else if (status === 'complete' && payload.result) {
        const meta = payload.result.metadata;
        const summary = meta?.resultsCount ? `å®Œæˆæ·±åº¦æœç´¢ Â· ${meta.resultsCount} æ¡ç»“æœ` : 'å®Œæˆæ·±åº¦æœç´¢';
        appendSearchLog(summary);
      }
    }

    if (stepType === 'reporting') {
      if (payload.chunk) {
        state.reportDraft += payload.chunk;
        renderResults();
      }
    }
  }

  function handleResearchStop() {
    updateHeroStatus(translate('researchFlow.stopped', {}, 'å·²åœæ­¢'));
  }

  function handleResearchComplete() {
    updateHeroStatus(translate(translationKeys.heroComplete, {}, 'ç ”ç©¶å®Œæˆ'));
    if (latestOutputValue) {
      latestOutputValue.textContent = formatTimestamp(new Date());
    }
  }

  function handleResearchError(event) {
    const message = event?.detail?.message || translate('researchFlow.detailError', {}, 'å‘ç”Ÿé”™è¯¯');
    updateHeroStatus(message);
    appendSearchLog(`âš ï¸ ${message}`);
  }

  document.addEventListener('research:start', handleResearchStart);
  document.addEventListener('research-update', handleResearchUpdate);
  document.addEventListener('research:stop', handleResearchStop);
  document.addEventListener('research:complete', handleResearchComplete);
  document.addEventListener('research:error', handleResearchError);

  if (steadyI18n && typeof steadyI18n.onLocaleChange === 'function') {
    steadyI18n.onLocaleChange(() => {
      renderResults();
      renderSources();
    });
  }
</script>