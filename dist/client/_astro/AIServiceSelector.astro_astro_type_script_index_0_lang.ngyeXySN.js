(()=>{const f=window.__steadyI18n||{},m=(e,t,a)=>{if(f&&typeof f.t=="function")try{const n=f.t(e,t);if(n!=null)return n}catch(n){console.warn("[i18n] translate error",n)}return a??e},d={idle:"idle",success:"success",warning:"warning",error:"error"},K="steady-research-pro:ai-service",r={deepseek:{name:"DeepSeek",nameKey:"aiService.optionDeepseek",info:"高性能大语言模型，支持中英文对话",infoKey:"aiService.remoteInfoDeepseek",models:["deepseek-chat","deepseek-coder"],defaultModel:"deepseek-chat"},openai:{name:"OpenAI",nameKey:"aiService.optionOpenai",info:"领先的通用对话模型，可完成生成和分析任务",infoKey:"aiService.remoteInfoOpenai",models:["gpt-3.5-turbo","gpt-4","gpt-4o-mini"],defaultModel:"gpt-3.5-turbo"},claude:{name:"Claude (Anthropic)",nameKey:"aiService.optionClaude",info:"擅长分析和推理的安全大模型",infoKey:"aiService.remoteInfoClaude",models:["claude-3-haiku-20240307","claude-3-sonnet-20240229","claude-3-opus-20240229"],defaultModel:"claude-3-haiku-20240307"},gemini:{name:"Google Gemini",nameKey:"aiService.optionGemini",info:"谷歌最新多模态模型，擅长创意和多模态任务",infoKey:"aiService.remoteInfoGemini",models:["gemini-1.5-flash-latest","gemini-1.5-pro-latest","gemini-pro"],defaultModel:"gemini-1.5-flash-latest"}},i={ollama:{type:"local",name:"本地Ollama",nameKey:"aiService.optionOllama",url:"http://localhost:11434",model:"",available:!1,models:[],deepAgent:{enabled:!1,search:"",modeling:"",report:""}},deepseek:{type:"remote",name:r.deepseek.name,nameKey:r.deepseek.nameKey,apiKey:"",model:r.deepseek.defaultModel,available:!1,models:[...r.deepseek.models],deepAgent:{enabled:!1,search:r.deepseek.defaultModel,modeling:r.deepseek.defaultModel,report:r.deepseek.defaultModel}},openai:{type:"remote",name:r.openai.name,nameKey:r.openai.nameKey,apiKey:"",model:r.openai.defaultModel,available:!1,models:[...r.openai.models],deepAgent:{enabled:!1,search:r.openai.defaultModel,modeling:r.openai.defaultModel,report:r.openai.defaultModel}},claude:{type:"remote",name:r.claude.name,nameKey:r.claude.nameKey,apiKey:"",model:r.claude.defaultModel,available:!1,models:[...r.claude.models],deepAgent:{enabled:!1,search:r.claude.defaultModel,modeling:r.claude.defaultModel,report:r.claude.defaultModel}},gemini:{type:"remote",name:r.gemini.name,nameKey:r.gemini.nameKey,apiKey:"",model:r.gemini.defaultModel,available:!1,models:[...r.gemini.models],deepAgent:{enabled:!1,search:r.gemini.defaultModel,modeling:r.gemini.defaultModel,report:r.gemini.defaultModel}}};let s="ollama",D=!1;const o={root:document.querySelector(".ai-service-panel"),currentSelection:document.getElementById("currentSelection"),selectionDetails:document.getElementById("selectionDetails"),providerSelect:document.getElementById("aiProvider"),providerName:document.getElementById("providerName"),providerInfo:document.getElementById("providerInfo"),sections:{ollama:document.getElementById("ollamaConfig"),http:document.getElementById("httpApiConfig")},inputs:{ollamaUrl:document.getElementById("ollamaUrl"),ollamaModel:document.getElementById("ollamaModel"),apiKey:document.getElementById("apiKey"),apiModel:document.getElementById("apiModel")},buttons:{testOllama:document.getElementById("testOllama"),testHttp:document.getElementById("testHttpApi")},badges:{ollama:document.getElementById("ollamaStatus"),remote:document.getElementById("httpApiStatus")},deepAgent:{ollama:{toggle:document.getElementById("ollamaDeepAgentEnabled"),grid:document.getElementById("ollamaDeepAgentGrid"),selects:{search:document.getElementById("ollamaDeepAgentSearch"),modeling:document.getElementById("ollamaDeepAgentModeling"),report:document.getElementById("ollamaDeepAgentReport")},hint:document.getElementById("ollamaDeepAgentHint")},remote:{toggle:document.getElementById("remoteDeepAgentEnabled"),grid:document.getElementById("remoteDeepAgentGrid"),selects:{search:document.getElementById("remoteDeepAgentSearch"),modeling:document.getElementById("remoteDeepAgentModeling"),report:document.getElementById("remoteDeepAgentReport")},hint:document.getElementById("remoteDeepAgentHint")}}},A=()=>{f&&typeof f.applyTranslations=="function"&&f.applyTranslations(o.root||document)},E=["search","modeling","report"],O=e=>e==="ollama"?o.deepAgent.ollama:o.deepAgent.remote;function B(e){const t=i[e];if(!t)return[];if(Array.isArray(t.models)&&t.models.length)return[...new Set(t.models)].filter(a=>typeof a=="string"&&a.trim().length).map(a=>a.trim());if(e!=="ollama"){const a=r[e];if(a?.models)return[...a.models]}return[]}function y(e,t={}){const a=B(e),n=l=>!l||typeof l!="string"?"":a.length?a.includes(l)?l:"":l;return{enabled:!!t.enabled,search:n(t.search),modeling:n(t.modeling),report:n(t.report)}}function h(e,t={}){if(!i[e])return{enabled:!1,search:"",modeling:"",report:""};const n={...i[e].deepAgent||{},...t},l=y(e,n);return i[e].deepAgent=l,l}function G(e,t){e&&e.grid&&e.grid.classList.toggle("deep-agent-grid--disabled",!t)}function U(e,t,a){if(!e)return;const n=typeof a=="string"?a:"";e.innerHTML="";const l=document.createElement("option");if(l.value="",l.textContent=m("aiService.deepAgentInherit",{},"沿用主模型"),l.dataset.i18n="aiService.deepAgentInherit",e.appendChild(l),t.forEach(u=>{const b=document.createElement("option");b.value=u,b.textContent=u,e.appendChild(b)}),n&&t.length&&!t.includes(n)){const u=document.createElement("option");u.value=n,u.textContent=n,e.appendChild(u)}n?(e.value=n,e.value!==n&&(e.value="")):e.value=""}function J(e,t,a){e&&(E.forEach(n=>{U(e.selects?.[n],t,a[n])}),f&&typeof f.applyTranslations=="function"&&[e.grid,e.hint].filter(Boolean).forEach(l=>f.applyTranslations(l)))}function P(e,t,a){if(!t?.hint)return;if(!a.enabled){t.hint.textContent=m("aiService.deepAgentHintDisabled",{},"未启用深度代理映射，将使用主模型。");return}const n=i[e]?.model||"",l=n?`未设置的阶段将沿用主模型：${n}`:"未设置的阶段将沿用主模型。";t.hint.textContent=m("aiService.deepAgentHintActive",{model:n},l)}function v(e){const t=O(e),a=i[e];if(!t||!a)return;const n=h(e);t.toggle&&(t.toggle.checked=!!n.enabled),G(t,n.enabled);const l=B(e);J(t,l,n),P(e,t,n)}function _(){const e={};return Object.entries(i).forEach(([t,a])=>{a&&(e[t]=y(t,a.deepAgent||{}))}),e}function S(){const e=_();typeof window<"u"&&(window.steadyResearchConfig=window.steadyResearchConfig||{},window.steadyResearchConfig.providerDeepAgent=e,window.dispatchEvent(new CustomEvent("deepAgent:providerMapping",{detail:e})))}function T(e,t){h(e,{enabled:!!t}),v(e),p(),e===s?g():S()}function L(e,t,a){if(!E.includes(t))return;const n=h(e,{[t]:a||""});h(e,n),P(e,O(e),n),p(),e===s?g():S()}function k(e,t,a){if(!i[e])return;const l=h(e),u=typeof t=="string"?t:"",b=typeof a=="string"?a:"";E.forEach(j=>{const R=l[j];(!R||R===b)&&(l[j]=u)}),h(e,l),v(e),p(),e===s?g():S()}function M(){D||(D=!0,z(),F(),x(),w(),Y(),A())}function z(){o.providerSelect?.addEventListener("change",a=>{const n=(a.target||{}).value;n&&N(n)}),o.inputs.ollamaUrl?.addEventListener("change",a=>{i.ollama.url=(a.target||{}).value?.trim()||i.ollama.url,p(),I()}),o.inputs.ollamaModel?.addEventListener("change",a=>{const n=i.ollama.model;i.ollama.model=(a.target||{}).value||"",k("ollama",i.ollama.model,n)}),o.inputs.apiKey?.addEventListener("input",a=>{const n=(a.target||{}).value?.trim()||"",l=i[s];l&&l.type==="remote"&&(l.apiKey=n,H(),p())}),o.inputs.apiModel?.addEventListener("change",a=>{const n=(a.target||{}).value||"",l=i[s];if(l&&l.type==="remote"){const u=l.model;l.model=n,k(s,n,u)}}),o.buttons.testOllama?.addEventListener("click",V),o.buttons.testHttp?.addEventListener("click",W);const e=o.deepAgent.ollama;e?.toggle&&e.toggle.addEventListener("change",a=>{T("ollama",a.target?.checked)}),e?.selects&&Object.entries(e.selects).forEach(([a,n])=>{n?.addEventListener("change",l=>{L("ollama",a,l.target?.value||"")})});const t=o.deepAgent.remote;t?.toggle&&t.toggle.addEventListener("change",a=>{s!=="ollama"&&T(s,a.target?.checked)}),t?.selects&&Object.entries(t.selects).forEach(([a,n])=>{n?.addEventListener("change",l=>{s!=="ollama"&&L(s,a,l.target?.value||"")})})}function F(){try{const e=localStorage.getItem(K);if(!e)return;const t=JSON.parse(e);t?.currentProvider&&i[t.currentProvider]&&(s=t.currentProvider),t?.providers&&Object.keys(t.providers).forEach(a=>{if(i[a]){const n=t.providers[a],l={...i[a],...n};Array.isArray(n?.models)&&(l.models=[...n.models]),n?.deepAgent?l.deepAgent=y(a,n.deepAgent):l.deepAgent=y(a,l.deepAgent||i[a].deepAgent||{}),i[a]=l}})}catch(e){console.warn("加载 AI 服务配置失败:",e)}o.providerSelect&&(o.providerSelect.value=s),C(),S()}function C(){const e=i[s];e&&(s==="ollama"?(o.inputs.ollamaUrl&&(o.inputs.ollamaUrl.value=e.url||""),o.inputs.ollamaModel&&e.model&&(o.inputs.ollamaModel.value=e.model)):(o.inputs.apiKey&&(o.inputs.apiKey.value=e.apiKey||""),q(s),o.inputs.apiModel&&e.model&&(o.inputs.apiModel.value=e.model)),H(),v("ollama"),s!=="ollama"&&v(s))}function x(){I(),$(),C(),A()}function I(){const e=i[s];if(e){if(o.currentSelection&&(o.currentSelection.textContent=m(e.nameKey||"",{},e.name||s)),o.selectionDetails)if(s==="ollama"){const t=e.url||"http://localhost:11434";o.selectionDetails.textContent=m("aiService.currentDetailsWithUrl",{url:t},`使用本地Ollama服务 (${t})`)}else{const t=r[s],a=m(t?.nameKey||"",{},t?.name||s),n=m(t?.infoKey||"aiService.remoteDescription",{provider:a},t?.info||m("aiService.remoteDescription",{},"请配置 API 密钥以使用此服务"));o.selectionDetails.textContent=n}if(s!=="ollama"){const t=r[s],a=m(t?.nameKey||"",{},t?.name||"云端 API 服务"),n=m(t?.infoKey||"aiService.remoteDescription",{provider:a},t?.info||m("aiService.remoteDescription",{},"请配置 API 密钥以使用此服务"));o.providerName&&(o.providerName.textContent=a),o.providerInfo&&(o.providerInfo.textContent=n)}}}function $(){s==="ollama"?(o.sections.ollama?.classList.remove("hidden"),o.sections.http?.classList.add("hidden")):(o.sections.ollama?.classList.add("hidden"),o.sections.http?.classList.remove("hidden"))}function q(e){const t=r[e];if(!t||!o.inputs.apiModel)return;o.inputs.apiModel.innerHTML="";const a=document.createElement("option");a.value="",a.textContent=m("aiService.remoteModelPlaceholder",{},"请选择模型"),a.dataset.i18n="aiService.remoteModelPlaceholder",o.inputs.apiModel.appendChild(a),t.models.forEach(n=>{const l=document.createElement("option");l.value=n,l.textContent=n,o.inputs.apiModel.appendChild(l)}),i[e]&&(i[e].models=[...t.models]),A(),s===e&&v(e)}function p(){try{localStorage.setItem(K,JSON.stringify({currentProvider:s,providers:i}))}catch(e){console.warn("保存 AI 服务配置失败:",e)}}function c(e,t,a,n,l){e&&(e.dataset.tone=t,e.textContent=m(a,l,n??a))}async function V(){c(o.badges.ollama,d.warning,"aiService.statusTesting","测试中");try{(await(await fetch("/api/ollama",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"health"})})).json()).healthy?(i.ollama.available=!0,c(o.badges.ollama,d.success,"aiService.statusReady","连接正常")):(i.ollama.available=!1,c(o.badges.ollama,d.error,"aiService.statusOffline","服务离线"))}catch{i.ollama.available=!1,c(o.badges.ollama,d.error,"aiService.statusFailed","连接失败")}p(),g()}async function W(){if(s==="ollama")return;const e=i[s];if(e?.apiKey){c(o.badges.remote,d.warning,"aiService.statusTesting","测试中"),o.buttons.testHttp?.setAttribute("data-loading","true");try{const t=await fetch("/api/http-api",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({provider:s,message:"status-check",apiKey:e.apiKey,model:e.model})});if(!t.ok)throw new Error("请求失败");const n=(await t.json())?.success!==!1;i[s].available=n,c(o.badges.remote,n?d.success:d.error,n?"aiService.statusReady":"aiService.statusFailed",n?"连接正常":"连接失败")}catch{i[s].available=!1,c(o.badges.remote,d.error,"aiService.statusError","连接异常")}finally{o.buttons.testHttp?.removeAttribute("data-loading"),p(),g()}}}async function Y(){try{const t=await(await fetch("/api/ollama",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"models"})})).json();if(Array.isArray(t?.models)&&o.inputs.ollamaModel){if(o.inputs.ollamaModel.innerHTML="",t.models.length===0){const a=document.createElement("option");a.value="",a.dataset.i18n="aiService.noModels",a.textContent=m("aiService.noModels",{},"暂无模型"),o.inputs.ollamaModel.appendChild(a),i.ollama.available=!1,i.ollama.models=[],c(o.badges.ollama,d.warning,"aiService.statusNoModels","暂无模型")}else{const a=document.createElement("option");a.value="",a.dataset.i18n="aiService.remoteModelPlaceholder",a.textContent=m("aiService.remoteModelPlaceholder",{},"请选择模型"),o.inputs.ollamaModel.appendChild(a),t.models.forEach(n=>{const l=document.createElement("option");l.value=n.name,l.textContent=n.name,o.inputs.ollamaModel.appendChild(l)}),i.ollama.model&&(o.inputs.ollamaModel.value=i.ollama.model),i.ollama.available=!0,i.ollama.models=t.models.map(n=>n.name),c(o.badges.ollama,d.success,"aiService.statusReady","连接正常")}A()}else i.ollama.available=!1,c(o.badges.ollama,d.error,"aiService.statusError","连接异常")}catch{c(o.badges.ollama,d.error,"aiService.statusError","连接异常"),i.ollama.available=!1,i.ollama.models=[]}finally{v("ollama"),s==="ollama"?g():S(),p()}}async function w(){s==="ollama"?await Q():await X(s)}async function Q(){try{const t=await(await fetch("/api/ollama",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"health"})})).json();i.ollama.available=!!t?.healthy,c(o.badges.ollama,t?.healthy?d.success:d.error,t?.healthy?"aiService.statusReady":"aiService.statusOffline",t?.healthy?"连接正常":"服务离线")}catch{i.ollama.available=!1,c(o.badges.ollama,d.error,"aiService.statusError","连接异常")}finally{p()}}async function X(e){const t=i[e];if(t){if(!t.apiKey){c(o.badges.remote,d.idle,"aiService.statusMissingKey","未配置");return}try{const l=(await(await fetch("/api/http-api")).json())?.status?.[e];l?.hasApiKey&&l?.connected?(i[e].available=!0,c(o.badges.remote,d.success,"aiService.statusReady","连接正常")):l?.hasApiKey?(i[e].available=!1,c(o.badges.remote,d.warning,"aiService.statusPending","待测试")):(i[e].available=!1,c(o.badges.remote,d.idle,"aiService.statusMissingKey","未配置"))}catch{i[e].available=!1,c(o.badges.remote,d.error,"aiService.statusError","连接异常")}finally{p()}}}function H(){const e=i[s];if(!o.buttons.testHttp)return;const t=!e||e.type!=="remote"||!e.apiKey;o.buttons.testHttp.disabled=t}function N(e){i[e]&&(s=e,o.providerSelect&&o.providerSelect.value!==e&&(o.providerSelect.value=e),x(),p(),w(),A(),g())}function g(){const e=i[s];if(!e)return;const t=Array.isArray(e?.models)?[...e.models]:[],a=y(s,e?.deepAgent||{});i[s]&&(i[s].deepAgent=a);const n={...e,models:t,deepAgent:a},l={provider:s,config:n,models:t,deepAgent:a};window.dispatchEvent(new CustomEvent("aiProviderChanged",{detail:l})),S()}window.getAIServiceSelector=()=>({getCurrentProvider:()=>{const e=i[s],t=Array.isArray(e?.models)?[...e.models]:[];return{provider:s,config:{...e,models:t},models:t}},setProvider:N,refreshStatuses:w,setConfig:(e,t)=>{if(!i[e])return;const a={...i[e],...t};Array.isArray(t?.models)&&(a.models=[...t.models]),t?.deepAgent&&(a.deepAgent=y(e,t.deepAgent)),i[e]=a,e===s&&(C(),I()),p(),g()}}),document.readyState==="complete"||document.readyState==="interactive"?M():document.addEventListener("DOMContentLoaded",M),document.addEventListener("astro:page-load",M)})();
