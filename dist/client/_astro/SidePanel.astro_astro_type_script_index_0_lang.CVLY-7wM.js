let u=!1,h=null,d={provider:"manual",config:null,models:[]},v=null;const oe="steady-research-pro:search-config",re="steady-research-pro:ai-service",ie=document.getElementById("research-topic"),V=document.getElementById("research-model"),ae=document.getElementById("depth-level"),de=document.getElementById("research-focus"),g=document.getElementById("start-btn"),A=document.getElementById("stop-btn"),T=document.getElementById("progress-bar"),C=document.getElementById("progress-meta"),U=document.getElementById("progress-timeline"),le=document.getElementById("config-form"),y=document.getElementById("provider-hint"),p=window.__steadyI18n||{},o=(e,t,n)=>{if(p&&typeof p.t=="function")try{return p.t(e,t)}catch(s){console.warn("[i18n] translate error",s)}return n??e},W=[{id:"plan",stepType:"plan",key:"sidePanel.stepPlan",fallback:"生成研究计划",icon:"📋"},{id:"search",stepType:"search",key:"sidePanel.stepSearch",fallback:"多源搜索",icon:"🔍"},{id:"extract",stepType:"extract",key:"sidePanel.stepExtract",fallback:"内容提取",icon:"📄"},{id:"cluster",stepType:"cluster",key:"sidePanel.stepCluster",fallback:"主题聚类",icon:"🔗"},{id:"synthesis",stepType:"synthesis",key:"sidePanel.stepSynthesis",fallback:"综合分析",icon:"🧠"}],ce=[{id:"plan",stepType:"plan",key:"sidePanel.stepPlan",fallback:"生成研究计划",icon:"📋"},{id:"search",stepType:"deep_search",key:"sidePanel.stepDeepSearch",fallback:"多源深度搜索",icon:"🔎"},{id:"cluster",stepType:"modeling",key:"sidePanel.stepModeling",fallback:"结构化建模",icon:"🧩"},{id:"synthesis",stepType:"reporting",key:"sidePanel.stepReporting",fallback:"智能报告生成",icon:"📝"}];let w=[...W];const E=new Map,i={mode:"legacy",deepAgent:null,search:null,providerDeepAgent:{}};function pe(){if(typeof window>"u")return null;const e=window;return typeof e.getAIServiceSelector=="function"?e.getAIServiceSelector():null}function ue(){typeof window>"u"||(v&&window.clearTimeout(v),v=window.setTimeout(()=>{v=null,R()},400))}function R(e){let t="manual",n=null,s=[];if(e?.provider)t=e.provider,n=e.config||null,Array.isArray(e.models)?s=[...e.models]:Array.isArray(e.config?.models)&&(s=[...e.config.models]);else{const r=pe();if(r?.getCurrentProvider){const l=r.getCurrentProvider();l&&(t=l.provider,n=l.config||null,Array.isArray(l.models)?s=[...l.models]:Array.isArray(l.config?.models)&&(s=[...l.config.models]))}}if(!n){d={provider:t,config:null,models:[]},_(),I(),e||ue();return}v&&(window.clearTimeout(v),v=null),d={provider:t,config:n,models:s};const a=e?.deepAgent||n?.deepAgent;a&&(i.providerDeepAgent={...i.providerDeepAgent||{},[t]:{...a}},typeof window<"u"&&(window.steadyResearchConfig=window.steadyResearchConfig||{},window.steadyResearchConfig.providerDeepAgent={...window.steadyResearchConfig.providerDeepAgent||{},[t]:{...a}})),_(),I()}function _(){const e=V;if(!e)return;const t=Array.isArray(d.models)?d.models:[],n=d.config?.model;if(e.innerHTML="",t.length>0){const s=document.createElement("option");s.value="",s.textContent=o("sidePanel.modelPlaceholder",{},"请选择模型"),e.appendChild(s),t.forEach(a=>{const r=document.createElement("option");r.value=a,r.textContent=a,e.appendChild(r)}),n&&t.includes(n)&&(e.value=n)}else if(n){const s=document.createElement("option");s.value=n,s.textContent=n,e.appendChild(s),e.value=n}else{const s=document.createElement("option");s.value="",s.textContent=o("sidePanel.providerMissing",{},"请在 Settings 页面配置模型"),e.appendChild(s),e.value=""}e.disabled=t.length===0&&!n,p&&typeof p.applyTranslations=="function"&&p.applyTranslations(e)}function I(){if(y)if(!d.config)y.textContent=o("sidePanel.providerMissing",{},"当前没有配置 AI 服务，请先前往 Settings 设置。"),y.classList.remove("text-slate-400","text-emerald-300","text-amber-300","text-rose-400"),y.classList.add("text-rose-400");else{const{name:e,available:t,model:n}=d.config,a=o(t?"sidePanel.providerStatusConnected":"sidePanel.providerStatusDisconnected",{},t?"已连接":"未连接"),r=n?o("sidePanel.providerStatusModelSuffix",{model:n},` · 模型：${n}`):"";y.textContent=o("sidePanel.providerStatus",{name:e||d.provider,status:a,model:r},`当前服务：${e||d.provider} · 状态：${a}${r}`),y.classList.remove("text-slate-400","text-emerald-300","text-amber-300","text-rose-400"),y.classList.add(t?"text-emerald-300":"text-amber-300")}if(g)if(u)g.disabled=!0;else{const e=!d.config||!d.config.available;g.disabled=e,g.classList.toggle("opacity-50",e),g.classList.toggle("cursor-not-allowed",e)}}function z(){if(typeof window>"u"||!window.localStorage)return null;try{const e=window.localStorage.getItem(oe);return e?JSON.parse(e):null}catch(e){return console.warn("[search-config] failed to read storage",e),null}}function fe(){if(typeof window>"u"||!window.localStorage)return null;try{const e=window.localStorage.getItem(re);return e?JSON.parse(e):null}catch(e){return console.warn("[ai-service] failed to read storage",e),null}}function ge(e){if(!e?.providers)return{};const t={};return Object.entries(e.providers).forEach(([n,s])=>{s?.deepAgent&&(t[n]={...s.deepAgent})}),t}function me(){return typeof window<"u"&&window.steadyResearchConfig?.deepAgent?window.steadyResearchConfig.deepAgent:z()?.deepAgent||null}function ye(){if(typeof window<"u"&&window.steadyResearchConfig?.providerDeepAgent)return{...window.steadyResearchConfig.providerDeepAgent};const e=fe();return ge(e||{})}function he(){if(typeof window<"u"&&window.steadyResearchConfig?.search)return window.steadyResearchConfig.search;const e=z();return e?{engines:Array.isArray(e.engines)?e.engines:[],bing:e.bing||"",google:e.google||"",googleCseId:e.googleCseId||""}:null}function F(){i.deepAgent=me(),i.search=he(),i.providerDeepAgent=ye()}function ve(e){if(!e)return null;const t=Array.isArray(e.engines)?e.engines.filter(Boolean):[],n={bing:e.bing||"",google:e.google||"",googleCseId:e.googleCseId||""},s=n.bing||n.google&&n.googleCseId;return!t.length&&!s?null:{engines:t.length?t:void 0,apiKeys:n}}function we(e){return e?.enabled?{enabled:!0,models:e.models||{},sampling:e.sampling||{},engines:e.engines||void 0,engineOptions:e.engineOptions||void 0,maxResults:typeof e.maxResults=="number"?e.maxResults:void 0,maxQueries:typeof e.maxQueries=="number"?e.maxQueries:void 0}:{enabled:!1}}function L(e){i.mode=e==="deep"?"deep":"legacy",w=i.mode==="deep"?ce:W,E.clear(),b()}function b(e=null){U&&(U.innerHTML=w.map(t=>{const n=E.get(t.id)||"pending";let s="bg-white/15",a="text-slate-500",r=o("sidePanel.stepPending",{},"等待执行");n==="done"?(s="bg-emerald-300",a="text-slate-200",r=o("sidePanel.stepComplete",{},"✓ 完成")):n==="active"||e&&t.id===e&&n!=="done"?(s="bg-brand-300 animate-pulse",a="text-white",r=o("sidePanel.stepRunning",{},"🔄 进行中")):n==="error"&&(s="bg-rose-400 animate-pulse",a="text-rose-200",r=o("sidePanel.stepError",{},"⚠️ 出错"));const l=o(t.key,{},t.fallback);return`
        <li class="before:content-[''] before:absolute before:-start-4 before:top-1.5 before:w-2 before:h-2 before:rounded-full before:${s} relative" data-step="${t.id}">
          <div class="flex items-center gap-2">
            <span class="text-sm">${t.icon}</span>
            <p class="text-xs font-medium ${a}">${l}</p>
          </div>
          <p class="text-[10px] text-slate-400 mt-0.5">${r}</p>
        </li>
      `}).join(""))}function x(e,t){e&&E.set(e,t)}function be(e){if(!e)return"";if(e.messageKey)try{return o(e.messageKey,e.messageParams||{},e.message||e.messageKey)}catch(t){console.warn("[research] translate message failed",t)}return e.message||""}function j(e,t){if(T&&Number.isFinite(e)){const n=Math.max(0,Math.min(100,e));T.style.width=`${n}%`}if(C){const n=t||o("sidePanel.progressIdle",{},"0% · 等待开始"),s=Number.isFinite(e)?`${Math.round(Math.max(0,Math.min(100,e)))}% · `:"";C.textContent=`${s}${n}`.trim()}}function H(){T&&(T.style.width="0%"),C&&(C.textContent=o("sidePanel.progressIdle",{},"0% · 等待开始"))}function Ae(e){const t=new CustomEvent("research-update",{detail:e});document.dispatchEvent(t)}function J(){g&&A&&(u?(g.classList.add("hidden"),A.classList.remove("hidden"),A.classList.add("inline-flex")):(g.classList.remove("hidden"),A.classList.add("hidden"),A.classList.remove("inline-flex"))),I()}function Ce(){const e=V?.value,t=d.config?.model;return e||t}async function Se(){const e=ie?.value?.trim(),t=Ce(),n=de?.value?.trim(),s=ae?.value||"standard";if(!e){alert(o("sidePanel.validationTopic",{},"请输入研究主题"));return}if(!d.config){alert(o("sidePanel.validationProvider",{},"请先在 Settings 页面配置 AI 服务"));return}if(!t){alert(o("sidePanel.validationModel",{},"请选择或配置 AI 模型"));return}if(!d.config.available){alert(o("sidePanel.validationOffline",{},"当前 AI 服务未连接，请先在 Settings 页面测试连接"));return}F();const a=ve(i.search),r=(i.providerDeepAgent||{})[d.provider]||{},l=we(i.deepAgent),P=!!l?.enabled,M={search:r.search||t,modeling:r.modeling||t,report:r.report||t},G=P?{...l,models:{search:l.models?.search||M.search,modeling:l.models?.modeling||M.modeling,report:l.models?.report||M.report},providerMapping:{...r,enabled:!!r?.enabled}}:null,Q=P?"deep":"legacy";L(Q),u=!0,J(),H(),document.dispatchEvent(new CustomEvent("research:start",{detail:{mode:Q,query:e,provider:d.provider,model:t,deepAgentEnabled:P}}));const k={depth:s,temperature:.7,focus:n};a&&(k.search=a),P&&G&&(k.deepAgent=G);try{const f=await fetch("/api/research-stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e,model:t,provider:d.provider,options:k})});if(!f.ok)throw new Error(`HTTP error! status: ${f.status}`);const D=f.body?.getReader(),X=new TextDecoder;if(h=D,!D)throw new Error("无法获取响应流");const Z=w[w.length-1];let B=!1,S="";for(;;){const{value:ee,done:te}=await D.read();if(te)break;S+=X.decode(ee,{stream:!0});let O;for(;(O=S.indexOf(`
`))!==-1;){const Y=S.slice(0,O).trim();if(S=S.slice(O+1),!Y.startsWith("data: "))continue;const $=Y.slice(6).trim();if(!$)continue;let c;try{c=JSON.parse($)}catch{console.warn("JSON 解析错误，跳过该行:",$);continue}if(c.done){B=!0;continue}if(!c.stepId)continue;const q=typeof c.data=="string"?{raw:c.data}:c.data||{},ne=q.stepType||c.stepId,m=w.find(K=>K.stepType===ne||K.id===c.stepId);m&&(c.status==="start"||c.status==="progress"?x(m.id,"active"):c.status==="complete"?(x(m.id,"done"),m.id===Z?.id&&(B=!0)):c.status==="error"&&x(m.id,"error"),b(m.id));const se=be(c);j(c.progress,se),Ae({...c,data:q,mode:i.mode})}}B?xe():u&&N()}catch(f){console.error("研究过程失败:",f),alert(o("sidePanel.researchFailed",{message:f.message},`研究失败: ${f.message}`)),document.dispatchEvent(new CustomEvent("research:error",{detail:{message:f.message}})),N()}}function N(){if(!u){if(h){try{h.cancel?.()}catch{console.log("Stream already closed")}h=null}return}if(u=!1,h){try{h.cancel?.()}catch{console.log("Stream already closed")}h=null}J(),E.clear(),b(),j(0,o("sidePanel.progressStopped",{},"已停止")),document.dispatchEvent(new CustomEvent("research:stop",{detail:{mode:i.mode}})),setTimeout(()=>H(),1500)}function xe(){if(!u)return;u=!1,J();const e=w[w.length-1];e&&(x(e.id,"done"),b(e.id)),j(100,o("sidePanel.progressCompleted",{},"研究完成")),document.dispatchEvent(new CustomEvent("research:complete",{detail:{mode:i.mode}})),setTimeout(()=>{E.clear(),b(),H()},3e3)}function Ee(){Pe(),R(),F(),L(i.deepAgent?.enabled?"deep":"legacy"),b(),p&&typeof p.applyTranslations=="function"&&p.applyTranslations(document.getElementById("side-panel"))}function Pe(){le?.addEventListener("submit",async e=>{e.preventDefault(),await Se()}),A?.addEventListener("click",()=>{N()}),window.addEventListener("aiProviderChanged",e=>{const t=e instanceof CustomEvent?e.detail:void 0;R(t)}),window.addEventListener("deepAgent:configChanged",e=>{i.deepAgent=e.detail||null,L(i.deepAgent?.enabled?"deep":"legacy")}),window.addEventListener("searchConfig:updated",e=>{i.search=e.detail||i.search}),window.addEventListener("deepAgent:providerMapping",e=>{const t=e instanceof CustomEvent?e.detail:void 0;t&&typeof t=="object"&&(i.providerDeepAgent=t)})}p&&typeof p.onLocaleChange=="function"&&p.onLocaleChange(()=>{b(),I(),_(),!u&&C&&(C.textContent=o("sidePanel.progressIdle",{},"0% · 等待开始"))});document.addEventListener("DOMContentLoaded",Ee);document.addEventListener("astro:page-load",()=>{R(),F(),L(i.deepAgent?.enabled?"deep":"legacy")});
