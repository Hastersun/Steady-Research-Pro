const T=document.getElementById("reasoning-steps"),q=document.getElementById("reasoning-panel"),b=document.getElementById("search-log"),O=document.getElementById("current-task-value"),F=document.getElementById("latest-output-value"),A=document.getElementById("results-grid"),L=document.getElementById("results-empty"),D=document.getElementById("sources-table-body"),H=document.getElementById("sources-empty-row"),g=H?H.querySelector("td"):null,y=document.getElementById("sources-update-hint"),C=g?g.textContent:"",N=y?y.textContent:"",S=window.__steadyI18n||{},l=(a,e,s)=>{try{if(S&&typeof S.t=="function")return S.t(a,e)}catch(t){console.warn("[i18n] translation error",t)}return typeof s=="string"?s:a},Y=[{id:"plan",stepType:"plan",key:"researchFlow.pipelinePlan",fallback:"生成初步研究计划"},{id:"search",stepType:"search",key:"researchFlow.pipelineSearch",fallback:"多源搜索与抓取"},{id:"extract",stepType:"extract",key:"researchFlow.pipelineExtract",fallback:"内容清洗与摘要抽取"},{id:"cluster",stepType:"cluster",key:"researchFlow.pipelineCluster",fallback:"主题聚类与归纳"},{id:"synthesis",stepType:"synthesis",key:"researchFlow.pipelineSynthesis",fallback:"综合分析与洞察输出"}],Q=[{id:"plan",stepType:"plan",key:"researchFlow.pipelinePlan",fallback:"生成初步研究计划"},{id:"deep_search",stepType:"deep_search",key:"researchFlow.pipelineDeepSearch",fallback:"多源深度搜索"},{id:"modeling",stepType:"modeling",key:"researchFlow.pipelineModeling",fallback:"结构化建模"},{id:"reporting",stepType:"reporting",key:"researchFlow.pipelineReporting",fallback:"智能报告生成"}];let P=Y;const _=new Map,R=new Map,c={mode:"legacy",query:"",results:{},reportDraft:""},z={heroIdle:"hero.currentTaskIdle",heroComplete:"hero.currentTaskComplete"};function W(a){P=a==="deep"?Q:Y}function J(a){return P.find(e=>e.stepType===a)||null}function p(a){return typeof a!="string"?"":a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function G(a){if(!a)return"";const e=typeof a=="string"?new Date(a):a;return Number.isNaN(e?.getTime?.())?"":e.toLocaleString()}function V(a){if(!a)return"";if(a.messageKey)try{return l(a.messageKey,a.messageParams||{},a.message||a.messageKey)}catch(e){console.warn("[research-ui] translate message failed",e)}return a.message||""}function X(a){_.clear(),R.clear(),T&&(T.innerHTML=""),q&&q.classList.add("hidden"),b&&(b.innerHTML="",b.classList.add("hidden")),A&&A.querySelectorAll('[data-dynamic-card="true"]').forEach(s=>s.remove()),L&&L.classList.remove("hidden"),D&&D.querySelectorAll('[data-dynamic-row="true"]').forEach(s=>s.remove()),H&&H.classList.remove("hidden"),y&&(y.classList.add("hidden"),N&&(y.textContent=N)),g&&C&&(g.textContent=C),c.results={},c.reportDraft="",c.query=a||""}function Z(){q&&q.classList.remove("hidden")}function ee(a,e){if(!T)return null;const s=T.children.length+1,t=document.createElement("li");t.className="rounded-xl border border-brand-300/30 bg-slate-900/55 shadow-soft backdrop-blur animate-slide-up",t.style.animationDelay=`${s*40}ms`,t.dataset.stepType=e;const u=`rs-summary-${e}-${s}`,m=l("researchFlow.detailPending",{},"待执行");t.innerHTML=`
      <button type="button" id="${u}" class="group w-full flex items-center justify-between gap-3 px-4 py-3 text-left cursor-pointer select-none text-slate-200/85">
        <span class="flex items-center gap-2 text-[11px] font-medium tracking-wide text-brand-200 uppercase">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M12 5l7 7-7 7"/></svg>
          Step ${String(s).padStart(2,"0")}
        </span>
        <span class="flex-1 truncate text-[11px] text-slate-400">${a}</span>
        <span class="status text-[10px] font-medium text-slate-500">${m}</span>
        <svg class="chevron w-3.5 h-3.5 text-slate-500 transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
      </button>
      <div class="detail px-5 pt-0 pb-3 space-y-1 text-[11px] leading-relaxed text-slate-300/85 border-t border-brand-300/20 overflow-hidden max-h-0 opacity-0 transition-all duration-300 ease-out"></div>
    `,T.appendChild(t);const n=t.querySelector(`#${u}`),r=t.querySelector(".detail"),i=t.querySelector(".status"),o=t.querySelector(".chevron");function x(d,k){d.getAttribute("data-open")==="true"?(d.setAttribute("data-open","false"),d instanceof HTMLElement&&(d.style.maxHeight="0px",d.style.opacity="0"),k?.classList.remove("rotate-180")):(d.setAttribute("data-open","true"),d instanceof HTMLElement&&(d.style.maxHeight=d.scrollHeight+"px",d.style.opacity="1"),k?.classList.add("rotate-180"))}n?.addEventListener("click",()=>{!r||!o||x(r,o)});function f(d,k="log"){if(!r)return;const $=document.createElement("div");$.className="relative pl-3";let K="bg-brand-400/70";k==="done"?(K="bg-emerald-300",$.classList.add("text-brand-200","font-medium")):k==="error"&&(K="bg-rose-400",$.classList.add("text-rose-300")),$.innerHTML=`<span class="absolute left-0 top-1 w-1 h-1 rounded-full ${K}"></span>${p(d)}`,r.appendChild($),r.getAttribute("data-open")==="true"&&r instanceof HTMLElement&&(r.style.maxHeight=r.scrollHeight+"px")}function h(d,k){i&&(i.textContent=d,i.className=`status text-[10px] font-medium ${k}`)}function I(){h(l("researchFlow.detailRunning",{},"执行中"),"text-brand-400"),f(l("researchFlow.detailStart",{label:a},`开始: ${a}`))}function M(){h(l("researchFlow.detailDone",{},"完成"),"text-emerald-400"),f(l("researchFlow.detailFinish",{},"完成 ✓"),"done")}function E(d){h(l("researchFlow.detailError",{},"异常"),"text-rose-400"),f(d||l("researchFlow.detailError",{},"发生错误"),"error")}function w(){!r||!(r instanceof HTMLElement)||(r.setAttribute("data-open","true"),r.style.maxHeight=r.scrollHeight+"px",r.style.opacity="1",o?.classList.add("rotate-180"))}return{start:I,finish:M,addLine:f,setError:E,expand:w}}function te(a){if(_.has(a))return _.get(a);const e=J(a),s=l(e?.key||"",{},e?.fallback||a),t=ee(s,a);return t&&_.set(a,t),t}function B(a){if(!b||!a)return;b.classList.remove("hidden");const e=document.createElement("div"),s=b.children.length;e.className="animate-fade-in",e.style.animationDelay=`${s*40}ms`,e.textContent=a,b.appendChild(e),b.scrollTop=b.scrollHeight}function se({id:a,order:e,title:s,badge:t,bodyHtml:u,footerHtml:m}){const n=document.createElement("article");return n.className="group relative overflow-hidden rounded-2xl border border-white/10 bg-slate-900/55 backdrop-blur p-6 shadow-soft transition-all duration-300 hover:-translate-y-1 hover:border-brand-400/40 hover:shadow-xl animate-slide-up",n.dataset.dynamicCard="true",n.dataset.cardId=a,n.style.animationDelay=`${e*70}ms`,n.innerHTML=`
      <div class="absolute inset-0 opacity-0 transition-opacity duration-300 group-hover:opacity-100" style="background: radial-gradient(circle at top, rgba(45, 212, 191, 0.22), transparent 60%);"></div>
      <div class="relative flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="inline-flex h-7 w-7 items-center justify-center rounded-full border border-white/10 bg-white/10 text-[11px] font-semibold text-white/80">${String(e+1).padStart(2,"0")}</span>
          <h3 class="text-sm font-semibold text-white flex items-center gap-2">
            <svg class="w-4 h-4 text-brand-200" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l4 2"/></svg>
            <span>${s}</span>
          </h3>
        </div>
        <span class="text-[11px] uppercase tracking-[0.22em] text-slate-400/70">${t}</span>
      </div>
      <div class="relative mt-3 text-xs text-slate-200/80 space-y-2 leading-relaxed">${u}</div>
      ${m?`<div class="relative mt-4 text-[11px] text-slate-300/70">${m}</div>`:""}
    `,n}function j(){if(!A)return;A.querySelectorAll('[data-dynamic-card="true"]').forEach(r=>r.remove());const e=[],s=c.results.plan,t=c.results.deep_search||c.results.search,u=c.results.modeling,m=c.results.reporting;if(s?.content){const r=s.content.split(/\n+/).filter(Boolean).map(i=>`<p>${p(i)}</p>`).join("");e.push({id:"plan-card",title:l("resultsGrid.planTitle",{},"研究计划"),badge:"PLAN",bodyHtml:`<div class="space-y-2">${r}</div>`,footerHtml:s.timestamp?l("resultsGrid.generatedAt",{time:G(s.timestamp)},`生成时间：${G(s.timestamp)}`):""})}if(t){const r=Array.isArray(t.summary?.highlights)?t.summary.highlights.slice(0,4):[],i=Array.isArray(t.notes)?t.notes.slice(0,3):[],o=t.metadata||{},x=o.fallbackMessage||l("resultsGrid.fallbackDefault",{},"搜索使用了回退策略。");let f="";o.fallbackReason==="summarize_unavailable"?f=l("resultsGrid.fallbackSummarize",{},"摘要生成暂不可用，展示原始搜索结果。"):o.fallbackReason==="api_error"?f=l("resultsGrid.fallbackApi",{},"搜索接口异常，已展示可用的缓存或计划。"):o.fallbackReason==="no_results"&&(f=l("resultsGrid.fallbackEmpty",{},"未检索到可靠来源，展示基础策略供参考。"));const h=o.isFallback?`
            <div class="flex items-start gap-2 rounded-lg border border-amber-200/40 bg-amber-500/10 px-3 py-2 text-[11px] text-amber-50">
              <span class="mt-0.5">⚠️</span>
              <div class="space-y-1">
                <p class="font-medium text-amber-100">${p(x)}</p>
                ${f?`<p class="text-amber-200/90">${p(f)}</p>`:""}
              </div>
            </div>
          `:"",I=r.length?`<ul class="list-disc ps-5 space-y-1">${r.map(d=>`<li>${p(d)}</li>`).join("")}</ul>`:"",M=i.length?i.map(d=>`
            <div class="rounded-lg border border-white/10 bg-white/5 px-3 py-2">
              <p class="font-medium text-slate-100/90">${p(d.topic||d.summary||"")}</p>
              <p class="text-[11px] text-slate-300/80 mt-1 line-clamp-3">${p(d.summary||"")}</p>
            </div>
          `).join(""):"",E=[];Array.isArray(t.strategy?.queries)&&E.push(`查询 ${t.strategy.queries.length} 个`),typeof t.metadata?.resultsCount=="number"&&E.push(`结果 ${t.metadata.resultsCount} 条`),o.isFallback&&E.push(l("resultsGrid.footerFallback",{},"回退模式"));let w="";h&&(w+=h),I&&(w+=I),M&&(w+=M),w||(w=`<p class="text-[11px] text-slate-300/70">${p(l("resultsGrid.searchAwaiting",{},"等待搜索摘要"))}</p>`),e.push({id:"search-card",title:l("resultsGrid.sectionBenchmark",{},"搜索洞察"),badge:"SEARCH",bodyHtml:`<div class="space-y-2">${w}</div>`,footerHtml:E.join(" · ")})}if(u){const r=Array.isArray(u.coreDrivers)?u.coreDrivers.slice(0,4):[],i=r.length?r.map((o,x)=>`
            <div class="flex items-start gap-2">
              <span class="mt-0.5 text-[11px] text-brand-200">${String(x+1).padStart(2,"0")}</span>
              <div>
                <p class="text-xs font-medium text-slate-100/90">${p(o.name||"关键驱动")}</p>
                <p class="text-[11px] text-slate-300/80 mt-0.5 line-clamp-3">${p(o.description||"")}</p>
              </div>
            </div>
          `).join(""):'<p class="text-[11px] text-slate-300/70">等待建模结果</p>';e.push({id:"model-card",title:l("resultsGrid.sectionFramework",{},"结构化模型"),badge:"MODEL",bodyHtml:`<div class="space-y-2">${i}</div>`,footerHtml:u.metadata?.method?`Method · ${p(u.metadata.method)}`:""})}const n=m?.markdown||c.reportDraft;if(n){const r=n.split(`
`).slice(0,8).map(i=>p(i)).join("<br />");e.push({id:"report-card",title:l("resultsGrid.sectionAction",{},"洞察报告"),badge:"REPORT",bodyHtml:`<p class="font-mono text-[11px] leading-relaxed whitespace-pre-wrap">${r}</p>`,footerHtml:m?.metadata?.format?`Format · ${p(m.metadata.format)}`:""})}if(!e.length){L&&L.classList.remove("hidden");return}L&&L.classList.add("hidden"),e.forEach((r,i)=>{const o=se({...r,order:i});A.appendChild(o)})}function ae(a){try{const{hostname:e}=new URL(a);return e.replace(/^www\./,"")}catch{return""}}function U(){if(!D)return;D.querySelectorAll('[data-dynamic-row="true"]').forEach(n=>n.remove());const e=c.results.deep_search||c.results.search,s=e?.metadata||{},t=Array.isArray(e?.notes)?e.notes:[],u=Array.isArray(e?.rawResults)?e.rawResults:[],m=t.length?t:u;if(y&&(s.isFallback&&s.fallbackReason==="summarize_unavailable"?y.textContent=l("sourcesTable.hintSummarizeFallback",{},"摘要失败，已展示原始来源列表。"):s.isFallback&&s.fallbackMessage?y.textContent=s.fallbackMessage:N&&(y.textContent=N)),!m.length){g&&(s.isFallback&&s.fallbackReason==="no_results"?g.textContent=l("sourcesTable.emptyNoResults",{},"搜索没有返回来源，保留策略建议供参考。"):s.isFallback&&s.fallbackReason==="api_error"?g.textContent=l("sourcesTable.emptyApiFallback",{},"搜索接口异常，暂无法展示来源列表。"):C&&(g.textContent=C)),H?.classList.remove("hidden"),y?.classList.add("hidden");return}g&&C&&(g.textContent=C),H?.classList.add("hidden"),y?.classList.remove("hidden"),m.slice(0,10).forEach(n=>{const r=n.title||n.summary||n.topic||"—",i=n.sourceUrl||n.url||n.link||"",o=i?ae(i):n.domain||"—",x=n.engine||n.type||"Source",f=typeof n.confidence=="number"?n.confidence.toFixed(2):typeof n.score=="number"?n.score.toFixed(2):"—",h=document.createElement("tr");h.className="hover:bg-gray-50/70 animate-fade-in",h.dataset.dynamicRow="true",h.innerHTML=`
        <td class="py-2 pe-4 max-w-[220px]"><div class="line-clamp-2 font-medium text-gray-700">${p(r)}</div></td>
        <td class="py-2 pe-4 text-gray-500">${p(o)}</td>
        <td class="py-2 pe-4"><span class="inline-flex items-center rounded bg-brand-50 px-2 py-0.5 text-[10px] font-medium text-brand-700 ring-1 ring-inset ring-brand-200/70">${p(x)}</span></td>
        <td class="py-2 pe-4 font-medium text-gray-800">${f}</td>
        <td class="py-2">
          ${i?`<a class="inline-flex items-center gap-1 rounded-full border border-gray-200 px-2 py-1 text-[11px] text-gray-500 hover:border-brand-300 hover:text-brand-500" href="${p(i)}" target="_blank" rel="noopener">查看</a>`:'<span class="text-[11px] text-gray-400">N/A</span>'}
        </td>
      `,D.appendChild(h)})}function v(a){O&&(O.textContent=a||l(z.heroIdle,{},"Idle"))}function re(a){const e=a?.detail||{},s=e.mode==="deep"?"deep":"legacy",t=e.query||"";c.mode=s,W(s),X(t),v(t||l(z.heroIdle,{},"Idle")),F&&(F.textContent="—"),j(),U()}function ne(a){const e=a?.detail||{},s=typeof e.data=="string"?{raw:e.data}:e.data||{},t=s.stepType||e.stepType||e.stepId;if(!t)return;const u=J(t)||{key:"",fallback:t},m=l(u.key||"",{},u.fallback||t),n=te(t),r=V(e)||V(s),i=e.status;if(Z(),i==="start")n?.start?.(),R.set(t,"active"),v(m);else if(i==="progress")r&&n?.addLine?.(r),R.set(t,"active"),v(r||m);else if(i==="complete"){n?.finish?.(),R.set(t,"done"),s.result&&(c.results[t]=s.result,t==="deep_search"&&(c.results.search=s.result),t==="search"&&!c.results.deep_search&&(c.results.deep_search=s.result),t==="cluster"&&!c.results.modeling&&(c.results.modeling=s.result),t==="reporting"&&(c.results.reporting=s.result,c.reportDraft=s.result.markdown||c.reportDraft),t==="synthesis"&&(c.results.reporting=s.result,typeof s.result?.content=="string"&&(c.reportDraft=s.result.content)),t==="plan"&&(c.results.plan=s.result),j(),U()),v(m);const o=P[P.length-1];o&&(o.stepType===t||o.id===t)&&(v(l(z.heroComplete,{},"研究完成")),F&&(F.textContent=G(e.timestamp||new Date)))}else if(i==="error"){const o=r||l("researchFlow.detailError",{},"发生错误");n?.setError?.(o),R.set(t,"error"),B(`⚠️ ${o}`),v(o)}if(t==="deep_search"){if(i==="progress"&&r)B(r);else if(i==="complete"&&s.result){const o=s.result.metadata,x=o?.resultsCount?`完成深度搜索 · ${o.resultsCount} 条结果`:"完成深度搜索";B(x)}}t==="reporting"&&s.chunk&&(c.reportDraft+=s.chunk,j())}function le(){v(l("researchFlow.stopped",{},"已停止"))}function oe(){v(l(z.heroComplete,{},"研究完成")),F&&(F.textContent=G(new Date))}function ie(a){const e=a?.detail?.message||l("researchFlow.detailError",{},"发生错误");v(e),B(`⚠️ ${e}`)}document.addEventListener("research:start",re);document.addEventListener("research-update",ne);document.addEventListener("research:stop",le);document.addEventListener("research:complete",oe);document.addEventListener("research:error",ie);S&&typeof S.onLocaleChange=="function"&&S.onLocaleChange(()=>{j(),U()});
